{
  "pipeline": {
    "name": "metadata_driven_dlt_pipeline",
    "load_strategy": "load_once"
  },
  "azure_sql": {
    "server": "fabricp",
    "password": ""
  },
  "tables": [
    {
      "table_name": "customer",
      "enabled": true,
      "layers": {
        "bronze": {
          "batch_precedence_id": 1,
          "type": "streaming",
          "source": {
            "system": "azure_sql",
            "database": "db_testing",
            "schema": "SalesLT",
            "table": "Customer"
          },
          "incremental": {
            "enabled": true,
            "column": "ModifiedDate"
          },
          "target": {
            "table": "bronze_customer"
          }
        },
        "silver": {
          "table_type": "dimension",
          "batch_precedence_id": 2,
          "dependency_type": "base",
          "input": "bronze_customer",
          "steps": [
            { "step_type": "generic_cleaning" },
            { "step_type": "lowercase_columns" },
            {
              "step_type": "handle_nulls",
              "options": {
                "fill_map": {
                  "companyname": "unknown",
                  "emailaddress": "unknown"
                }
              }
            },
            {
              "step_type": "mask_pii",
              "options": {
                "columns": ["emailaddress", "phone"]
              }
            },
            {
              "step_type": "add_surrogate_key",
              "options": {
                "natural_key": "customerid",
                "sk_name": "customer_sk"
              }
            }
          ],
          "output": {
            "table": "silver_customer"
          }
        }
      }
    },
    {
      "table_name": "address",
      "enabled": true,
      "layers": {
        "bronze": {
          "batch_precedence_id": 1,
          "type": "streaming",
          "source": {
            "system": "azure_sql",
            "database": "db_testing",
            "schema": "SalesLT",
            "table": "Address"
          },
          "incremental": {
            "enabled": true,
            "column": "ModifiedDate"
          },
          "target": {
            "table": "bronze_address"
          }
        },
        "silver": {
          "table_type": "dimension",
          "batch_precedence_id": 2,
          "dependency_type": "base",
          "input": "bronze_address",
          "steps": [
            { "step_type": "generic_cleaning" },
            { "step_type": "lowercase_columns" },
            {
              "step_type": "handle_nulls",
              "options": {
                "fill_map": {
                  "city": "unknown",
                  "stateprovince": "unknown"
                }
              }
            }
          ],
          "output": {
            "table": "silver_address"
          }
        }
      }
    },
    {
      "table_name": "customeraddress",
      "enabled": true,
      "layers": {
        "bronze": {
          "batch_precedence_id": 1,
          "type": "streaming",
          "source": {
            "system": "azure_sql",
            "database": "db_testing",
            "schema": "SalesLT",
            "table": "CustomerAddress"
          },
          "incremental": {
            "enabled": true,
            "column": "ModifiedDate"
          },
          "target": {
            "table": "bronze_customeraddress"
          }
        },
        "silver": {
          "table_type": "dimension",
          "batch_precedence_id": 2,
          "dependency_type": "base",
          "input": "bronze_customeraddress",
          "steps": [
            { "step_type": "generic_cleaning" },
            { "step_type": "lowercase_columns" },
            {
              "step_type": "apply_row_filters",
              "options": {
                "condition": "customerid IS NOT NULL AND addressid IS NOT NULL"
              }
            }
          ],
          "output": {
            "table": "silver_customeraddress"
          }
        }
      }
    },
    {
      "table_name": "product",
      "enabled": true,
      "layers": {
        "bronze": {
          "batch_precedence_id": 1,
          "type": "streaming",
          "source": {
            "system": "azure_sql",
            "database": "db_testing",
            "schema": "SalesLT",
            "table": "Product"
          },
          "incremental": {
            "enabled": true,
            "column": "ModifiedDate"
          },
          "target": {
            "table": "bronze_product"
          }
        },
        "silver": {
          "table_type": "dimension",
          "batch_precedence_id": 2,
          "dependency_type": "base",
          "input": "bronze_product",
          "steps": [
            { "step_type": "generic_cleaning" },
            { "step_type": "lowercase_columns" },
            {
              "step_type": "handle_nulls",
              "options": {
                "fill_map": {
                  "color": "unknown"
                }
              }
            }
          ],
          "output": {
            "table": "silver_product"
          }
        }
      }
    },
    {
      "table_name": "productcategory",
      "enabled": true,
      "layers": {
        "bronze": {
          "batch_precedence_id": 1,
          "type": "streaming",
          "source": {
            "system": "azure_sql",
            "database": "db_testing",
            "schema": "SalesLT",
            "table": "ProductCategory"
          },
          "incremental": {
            "enabled": true,
            "column": "ModifiedDate"
          },
          "target": {
            "table": "bronze_productcategory"
          }
        },
        "silver": {
          "table_type": "dimension",
          "batch_precedence_id": 2,
          "dependency_type": "base",
          "input": "bronze_productcategory",
          "steps": [
            { "step_type": "generic_cleaning" },
            { "step_type": "lowercase_columns" }
          ],
          "output": {
            "table": "silver_productcategory"
          }
        }
      }
    },
    {
      "table_name": "salesorderheader",
      "enabled": true,
      "layers": {
        "bronze": {
          "batch_precedence_id": 1,
          "type": "streaming",
          "source": {
            "system": "azure_sql",
            "database": "db_testing",
            "schema": "SalesLT",
            "table": "SalesOrderHeader"
          },
          "incremental": {
            "enabled": true,
            "column": "ModifiedDate"
          },
          "target": {
            "table": "bronze_salesorderheader"
          }
        },
        "silver": {
          "table_type": "fact",
          "batch_precedence_id": 2,
          "dependency_type": "base",
          "input": "bronze_salesorderheader",
          "steps": [
            { "step_type": "generic_cleaning" },
            { "step_type": "lowercase_columns" }
          ],
          "output": {
            "table": "silver_salesorderheader"
          }
        }
      }
    },
    {
      "table_name": "salesorderdetail",
      "enabled": true,
      "layers": {
        "bronze": {
          "batch_precedence_id": 1,
          "type": "streaming",
          "source": {
            "system": "azure_sql",
            "database": "db_testing",
            "schema": "SalesLT",
            "table": "SalesOrderDetail"
          },
          "incremental": {
            "enabled": true,
            "column": "ModifiedDate"
          },
          "target": {
            "table": "bronze_salesorderdetail"
          }
        },
        "silver": {
          "table_type": "fact",
          "batch_precedence_id": 2,
          "dependency_type": "base",
          "input": "bronze_salesorderdetail",
          "steps": [
            { "step_type": "generic_cleaning" },
            { "step_type": "lowercase_columns" },
            {
              "step_type": "apply_row_filters",
              "options": {
                "condition": "orderqty > 0 AND unitprice >= 0"
              }
            }
          ],
          "output": {
            "table": "silver_salesorderdetail"
          }
        }
      }
    },
    {
      "table_name": "customer_address_join",
      "enabled": true,
      "layers": {
        "silver": {
          "table_type": "dimension",
          "batch_precedence_id": 2,
          "dependency_type": "join",
          "input": "silver_customer",
          "joins": [
            {
              "table": "silver_customeraddress",
              "on": "customerid",
              "join_type": "left",
              "drop_columns": ["rowguid", "modifieddate", "silver_processed_ts"]
            },
            {
              "table": "silver_address",
              "on": "addressid",
              "join_type": "left",
              "drop_columns": ["rowguid", "modifieddate", "silver_processed_ts"]
            }
          ],
          "output": {
            "table": "silver_customer_address"
          }
        }
      }
    },
    {
      "table_name": "product_category_join",
      "enabled": true,
      "layers": {
        "silver": {
          "table_type": "dimension",
          "batch_precedence_id": 2,
          "dependency_type": "join",
          "input": "silver_product",
          "joins": [
            {
              "table": "silver_productcategory",
              "on": "productcategoryid",
              "join_type": "left",
              "drop_columns": ["name", "rowguid", "modifieddate", "silver_processed_ts"]
            }
          ],
          "output": {
            "table": "silver_product_dim"
          }
        }
      }
    },
    {
      "table_name": "order_fact_join",
      "enabled": true,
      "layers": {
        "silver": {
          "table_type": "dimension",
          "batch_precedence_id": 2,
          "dependency_type": "join",
          "input": "silver_salesorderheader",
          "joins": [
            {
              "table": "silver_salesorderdetail",
              "on": "salesorderid",
              "join_type": "inner",
              "drop_columns": ["rowguid", "modifieddate", "silver_processed_ts"]
            }
          ],
          "output": {
            "table": "silver_order_fact"
          }
        }
      }
    },
    {
      "table_name": "gold_customer_sales_kpi_sql",
      "enabled": true,
      "layers": {
        "gold": {
          "batch_precedence_id": 3,
          "kpi_type": "sql",
          "input_table": "silver_order_fact",
          "sql": "SELECT customerid, COUNT(DISTINCT salesorderid) AS total_orders, SUM(orderqty * unitprice) AS total_sales, AVG(orderqty * unitprice) AS avg_order_value FROM silver_order_fact GROUP BY customerid",
          "output": {
            "table": "gold_customer_sales_kpi"
          }
        }
      }
    },
    {
      "table_name": "gold_product_sales_kpi_sql",
      "enabled": true,
      "layers": {
        "gold": {
          "batch_precedence_id": 3,
          "kpi_type": "sql",
          "input_table": "silver_order_fact",
          "sql": "SELECT productid, SUM(orderqty) AS total_quantity_sold, SUM(orderqty * unitprice) AS total_revenue FROM silver_order_fact GROUP BY productid",
          "output": {
            "table": "gold_product_sales_kpi"
          }
        }
      }
    },
    {
      "table_name": "gold_daily_sales_kpi_sql",
      "enabled": true,
      "layers": {
        "gold": {
          "batch_precedence_id": 3,
          "kpi_type": "sql",
          "input_table": "silver_salesorderheader",
          "sql": "SELECT CAST(orderdate AS DATE) AS order_date, COUNT(DISTINCT salesorderid) AS total_orders, SUM(totaldue) AS total_revenue FROM silver_salesorderheader GROUP BY CAST(orderdate AS DATE)",
          "output": {
            "table": "gold_daily_sales_kpi"
          }
        }
      }
    },
    {
      "table_name": "gold_region_sales_kpi_sql",
      "enabled": true,
      "layers": {
        "gold": {
          "batch_precedence_id": 3,
          "kpi_type": "sql",
          "input_table": "silver_customer_address",
          "sql": "SELECT stateprovince, city, COUNT(DISTINCT salesorderid) AS total_orders, SUM(orderqty * unitprice) AS total_revenue FROM silver_customer_address ca JOIN silver_order_fact of ON ca.customerid = of.customerid GROUP BY stateprovince, city",
          "output": {
            "table": "gold_region_sales_kpi"
          }
        }
      }
    }
  ]
}
